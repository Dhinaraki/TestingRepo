name: Deploy Azure VM + NIC + Public IP

on:
  push:
    branches: [ main ]
  workflow_dispatch:          # Allows manual run from GitHub UI

permissions:
  id-token: write             # Required for OIDC
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC - secure & recommended)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy ARM Template
        uses: azure/bicep-deploy@v2     # Official, supports ARM JSON & Bicep, future-proof
        with:
          template: ./azuredeploy.json
          # parameters: ./azuredeploy.parameters.json   # ← uncomment if you create one

          # Or pass parameters inline (recommended for dynamic values)
          parameters: >-
            location=centralindia
            virtualMachineRG=${{ secrets.AZURE_RESOURCE_GROUP }}
            virtualMachineName2=testvm-${{ github.run_number }}
            virtualMachineComputerName2=testubuntu
            networkInterfaceName2=nic-${{ github.run_number }}
            publicIpAddressName2=pip-${{ github.run_number }}
            publicIpAddressType=Static
            publicIpAddressSku=Standard
            pipDeleteOption=Delete
            virtualMachineSize=Standard_B2s
            osDiskType=Premium_LRS
            osDiskDeleteOption=Delete
            nicDeleteOption=Delete
            hibernationEnabled=false
            adminUsername=azureuser
            enablePeriodicAssessment=ImageDefault
            securityType=TrustedLaunch
            secureBoot=true
            vTPM=true
            virtualMachine2Zone=1
            subnetId=${{ secrets.SUBNET_ID }}
            vnetResourceGroupName=my-rg-storage               # adjust if different
            vnetVirtualNetworkName=vnet-centralindia

          resourceGroupName: ${{ secrets.AZURE_RESOURCE_GROUP }}
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          deploymentName: vm-deploy-${{ github.sha }}
          mode: incremental
          failOnStdErr: true

      - name: Show deployment info
        if: always()
        run: |
          echo "Deployment → ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "Check in Azure Portal: https://portal.azure.com/#blade/HubsExtension/Resources/resourceGroup/${{ secrets.AZURE_RESOURCE_GROUP }}/overview"